# Prefect Infrastructure V1 

```mermaid
graph TD
    subgraph "Docker Host"
        subgraph "Network: prefect-server-network"
            direction TB
            A[Prefect Server Container]
            B[PostgreSQL Container]
            C[Local Storage]
        end

        subgraph "Network: prefect-agent-network"
            direction TB
            E[Prefect Agent Container]
            F[Business Logic Container]
        end
    end

    subgraph "External Network"
        direction TB
        D[User Browser]
    end

    D -->|HTTP:4200| A
    A -->|PostgreSQL:5432| B
    A -->|File System| C
    E -->|HTTP API:4200| A
    E -->|Inter-Process| F
    F -->|Inter-Process| E

    subgraph "Prefect Server Container"
        direction TB
        A1[Python 3.8-slim]
        A2[Poetry]
        A3[Prefect Server]
        A4[Prefect Config]
        A1 --> A2
        A2 --> A3
        A3 --> A4
    end

    subgraph "PostgreSQL Container"
        direction TB
        B1[PostgreSQL 13.3]
        B2[Database: prefect]
        B1 --> B2
    end

    subgraph "Local Storage"
        direction TB
        C1[Volume: /var/lib/prefect]
    end

    subgraph "Prefect Agent Container"
        direction TB
        E1[Python 3.8-slim]
        E2[Poetry]
        E3[Prefect Agent]
        E1 --> E2
        E2 --> E3
    end

    subgraph "Business Logic Container"
        direction TB
        F1[Python 3.8-slim]
        F2[Poetry]
        F3[Business Logic Flows and Tasks]
        F1 --> F2
        F2 --> F3
    end
```

## Tech Stack

Here is a summary of the technologies used:

- **Prefect**: For orchestrating and managing data workflows.
- **PostgreSQL**: As the database for storing Prefect metadata.
- **Local Storage**: For storing artifacts generated by Prefect flows.
- **Docker**: For containerizing the services.
- **Docker Compose**: For orchestrating multi-container Docker applications.

## System Architecture V1

### Design Principles

- assume on prem deployment
- assume centralized experiment tracking for inhouse experiments and SaaS

This document walks through the modules, their design patterns, and interactions with each other.

## Orchaestration Services

We built the orcahestration services with a few key technologies:
- **Prefect**: For orchestrating and managing data workflows.
- **PostgreSQL**: As the database for storing Prefect metadata.
- **Local Storage**: For storing artifacts generated by Prefect flows.
- (for later: Caddy for reverse proxy / https)



### Network Architecture

- **Prefect Network**: This network includes the Prefect server, PostgreSQL database, and local storage for artifacts.
- **Agent Network**: This network includes the Prefect agent and business logic containers. The business logic container will later be detached.

### Containers

1. **Prefect Server Container**:
   - **Base Image**: Python 3.8-slim
   - **Dependencies**: Poetry, Prefect, SQLAlchemy, asyncpg
   - **Configuration**: Prefect server configuration files
   - **Ports**: Exposes port 4200 for the Prefect UI

2. **PostgreSQL Container**:
   - **Image**: PostgreSQL 13.3
   - **Database**: Prefect metadata database

3. **Local Storage**:
   - **Volume**: Mounted volume for storing artifacts generated by Prefect flows

4. **Prefect Agent Container**:
   - **Base Image**: Python 3.8-slim
   - **Dependencies**: Poetry, Prefect
   - **Configuration**: Prefect agent configuration files

5. **Business Logic Container**:
   - **Base Image**: Python 3.8-slim
   - **Dependencies**: Poetry, Prefect
   - **Configuration**: Business logic, flows, and tasks

### Connections

1. **User Browser to Prefect Server Container**:
   - **Connection Type**: HTTP
   - **Port Number**: 4200
   - **Description**: The user makes HTTP requests directly to the Prefect server container to access the Prefect UI and API.

2. **Prefect Server Container to PostgreSQL Container**:
   - **Connection Type**: Database Connection (PostgreSQL)
   - **Port Number**: 5432
   - **Description**: The Prefect server container connects to the PostgreSQL container to interact with the database for storing metadata and flow information.

3. **Prefect Server Container to Local Storage**:
   - **Connection Type**: File System (Volume Mount)
   - **Port Number**: N/A
   - **Description**: The Prefect server container stores artifacts in the local storage volume. This is a file system operation and does not involve network ports.

4. **Prefect Agent Container to Prefect Server Container**:
   - **Connection Type**: API (HTTP)
   - **Port Number**: 4200
   - **Description**: The Prefect agent container polls the Prefect server container for flow runs and reports their status via HTTP API requests.

5. **Prefect Agent Container to Business Logic Container**:
   - **Connection Type**: Internal Execution (Inter-Process Communication)
   - **Port Number**: N/A
   - **Description**: The Prefect agent container executes the flows and tasks defined in the business logic container. This is typically done through inter-process communication within the same network.

### Developments

On successful proof of concept, the follwing ugprades will be made:
- dev config upgrade for inclusion of reverse proxy for remote access to between server <-> agent / production (caddy?)
- prod configs for hosting of server on VM (likely a digital ocean droplet)


